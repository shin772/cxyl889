FROM node:22-slim
LABEL "language"="nodejs"
LABEL "framework"="express"

WORKDIR /src

# 复制源代码
COPY . .

# 创建 package.json（如果不存在）
RUN if [ ! -f package.json ]; then \
  cat > package.json << 'EOF' \
{ \
  "name": "community-app", \
  "version": "1.0.0", \
  "description": "Community application", \
  "main": "server.js", \
  "scripts": { \
    "start": "node server.js", \
    "dev": "node server.js" \
  }, \
  "dependencies": { \
    "express": "^4.18.2", \
    "sqlite3": "^5.1.6", \
    "jsonwebtoken": "^9.1.2", \
    "multer": "^1.4.5-lts.1", \
    "cors": "^2.8.5" \
  } \
} \
EOF \
fi

# 安装依赖
RUN npm install

# 创建必要的目录
RUN mkdir -p public/uploads

# 暴露端口
EXPOSE 8080

# 启动应用
CMD ["node", "server.js"]
